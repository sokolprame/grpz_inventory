{% extends 'base.html' %}
{% block content %}
<div class="container mx-auto px-4 py-8">
    <h2 class="mb-6 border-b-2 border-red-500 pb-2 text-3xl font-bold text-gray-800">
        {% if component %}Редактировать компонент{% else %}Добавить компонент{% endif %}
    </h2>
    <div id="form-message" class="mx-auto mb-4 hidden max-w-2xl rounded-lg p-4 text-center"></div>
    <form method="post" enctype="multipart/form-data" id="component-form" class="mx-auto max-w-2xl space-y-4 rounded-xl border border-red-100 bg-white p-6 shadow-md">
        {% csrf_token %}
        {% for field in form %}
        <div class="flex flex-col">
            <label for="{{ field.id_for_label }}" class="mb-2 text-base font-medium text-red-800">{{ field.label }} {% if field.field.required %}<span class="text-red-600">*</span>{% endif %}</label>
            <div class="relative">
                {{ field }}
                {% if field.errors %}
                <p class="mt-1 text-sm text-red-600">{{ field.errors.as_text }}</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        <button type="submit" id="submit-button" class="bg-gradient-to-r flex w-full items-center justify-center rounded-lg from-red-600 to-red-700 py-3 text-lg font-bold text-white transition-all duration-300 hover:from-red-700 hover:to-red-800 hover:shadow-lg">
            <span id="submit-text">{% if component %}Сохранить{% else %}Добавить{% endif %}</span>
            <svg id="loading-icon" class="ml-2 hidden h-5 w-5 animate-spin text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8h8a8 8 0 01-16 0z"></path>
            </svg>
        </button>
    </form>

    <script>
        (function () {
            const form = document.getElementById('component-form');
            const messageDiv = document.getElementById('form-message');
            const submitButton = document.getElementById('submit-button');
            const submitText = document.getElementById('submit-text');
            const loadingIcon = document.getElementById('loading-icon');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            function showMessage(message, type) {
                messageDiv.classList.remove('hidden');
                messageDiv.textContent = message;
                messageDiv.classList.remove('bg-green-100', 'bg-red-100', 'text-green-800', 'text-red-800');
                if (type === 'success') {
                    messageDiv.classList.add('bg-green-100', 'text-green-800');
                } else {
                    messageDiv.classList.add('bg-red-100', 'text-red-800');
                }
            }

            function validateForm() {
                let isValid = true;
                form.querySelectorAll('input[required], select[required], textarea[required]').forEach(field => {
                    if (!field.value.trim()) {
                        isValid = false;
                        field.classList.add('border-red-500');
                        const label = field.previousElementSibling?.querySelector('label')?.textContent || field.name;
                        showMessage(`Поле "${label}" обязательно для заполнения.`, 'error');
                    } else {
                        field.classList.remove('border-red-500');
                    }
                });
                return isValid;
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateForm()) return;

                submitButton.disabled = true;
                submitText.classList.add('hidden');
                loadingIcon.classList.remove('hidden');

                const formData = new FormData(form);
                try {
                    const url = {% if component %}'{% url "components:edit" component.pk %}'{% else %} '{% url "components:add" %}'{% endif %};
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': csrfToken }
                });
                const data = await response.json();
                if (data.success) {
                    showMessage(data.message || 'Компонент сохранён!', 'success');
                    setTimeout(() => {
                        window.location.href = '{% url "components:component_list" %}';
                    }, 1500);
                } else {
                    showMessage('Ошибка: ' + (data.error || 'Проверьте данные.'), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Произошла ошибка: ' + error.message, 'error');
            } finally {
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                loadingIcon.classList.add('hidden');
            }
        });
            }) ();
    </script>
</div>
{% endblock %}